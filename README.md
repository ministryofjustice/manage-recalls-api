# Manage Recall API

[![CircleCI](https://circleci.com/gh/ministryofjustice/manage-recalls-api/tree/main.svg?style=svg)](https://circleci.com/gh/ministryofjustice/manage-recalls-api)
[![API docs](https://img.shields.io/badge/API_docs_-view-85EA2D.svg?logo=swagger)](https://manage-recalls-api-dev.hmpps.service.justice.gov.uk/swagger-ui/)

UK(ex-Scotland) MoJ API service for managing recalls. The main Slack channel for
the maintaining team is currently: `#ppud-replacement`

## Usage

A Recall in this sense is for an offender out on license to be recalled into detention
based on infringement of license conditions. Multiple agencies
participate in the Recall process including MoJ, HMPPS, prisons and police.

The primary software client for this service is the related UI `manage-recalls-ui`.

### Limitations

Current limitations of this service include:

- it is not yet the reference source for any operational Recall information:
  the PPUD system remains that.
- no historical data, i.e. from PPUD, is currently accessible via this service (or from any other DPS/HMPPS
  digital service).
- the exposed API is WIP: it has been created to satisfy the specific UI client; modifications to it may be
  appropriate for more general consumption.

### See Also

- pact/README.md
- pact/pact-webhooks/README.md
- helm_deploy/README.md

### Code style & formatting

```bash
./gradlew ktlintApplyToIdea addKtlintFormatGitPreCommitHook
```

will apply ktlint styles to intellij and also add a pre-commit hook to format all changed kotlin files.

### Run the service locally on the command line

Requires postgres and minio:

```
docker compose up -d postgres minio
```

Start with dev profile:

```bash
SPRING_PROFILES_ACTIVE=dev ./gradlew bootRun
```

You can now access the API at: http://localhost:8080

### Run in docker-compose

```bash
docker-compose pull && docker-compose up -d
```

The service should start up using the dev profile running on port 8080

### Run document generation test with gotenberg

In order to run tests against gotenberg running in docker:

```bash
./scripts/start-gotenburg.sh
./gradlew documentGenerationTest
./scripts/stop-gotenburg.sh
```

The following script runs the document generation tests in its own docker container, this is used by circleCI (this is
very slow running locally, the base docker image needs enhancing so we don't download gradle and all the dependencies
every time)

`scripts/run-docker-integration-tests.sh`

### Full local build

Builds everything, runs the unit tests, integration tests, start gotenberg and document generation tests

`./build.sh`

Note: this script will start up a `postgresql` and `minio` instance using `docker-compose` in the background.

### Swagger UI

We are using springfox to autogenerate the swagger docs. Go to http://localhost:9091/swagger-ui/ locally to see what it
generates. See `SpringFoxConfig` to control which endpoints etc it hits, currently it is generating for _everything_

### Dependee APIs

This service depends on a set of service APIs supplied within MoJ.
Links to Swagger for them can be found via e.g. https://structurizr.com/share/56937/documentation/*#Published%20APIs

An example is at: https://prisoner-offender-search-dev.prison.service.justice.gov.uk/swagger-ui/index.html?configUrl=/v3/api-docs/swagger-config#/prisoner-search-resource/findByCriteria_1

Those APIs can be tried out from a Dev laptop using e.g. Postman, curl etc.
The script `./scripts/getAccessToken.sh <env>` can be used to output an authorisation Bearer Token
to give access to those end-points, i.e. using `--header 'Authorization: Bearer <token>'` with curl.
Use lowercase env, defaults to `dev` with no argument.

### Postman against locally running API

Create a bearer token from local hmpps-auth (whilst we still use it) using:
`curl -sX POST "http://localhost:9090/auth/oauth/token?grant_type=password&username=PPUD_USER&password=password123456" -H 'Authorization: Basic ZWxpdGUyYXBpY2xpZW50OmNsaWVudHNlY3JldA==' | jq .access_token`

## Static inputs

Various non-code content of the project has been generated by one-off processing.

### Document templates

Section TBD.

### Static data

Some data not available via APIs has been copied into this source - and some of that has required
considerable processing as part of that, e.g.:

#### PPUD "LOV" Index Offence Data

See directory "PPUD-LOV-Index-Offences".
Processing by 'awk' etc. has been used to transform spread-sheet dump of this data from
legacy PPUD into usable code, e.g. enum definitions via `offences.awk` and `groups.awk`.

```
# Generate source values for 'enum class IndexOffence(val label: String, val group: IndexOffenceGroup)'
# Execute as e.g.:
# 1. start with s/sheet/.xls export of LOV table: expect tab per key, e.g. 2nd tab for offence groups
# 2. edit in e.g. Numbers to (i) replace "," with "|"; (ii) delete row 0 column headings;
# 3. export to CSV; file per sheet created e.g. as/renamed as "LOV-IndexOffencesExportBarForComma.csv"
# awk -f offences.awk < LOV-IndexOffencesExportBarForComma.csv | iconv -c --to-code=UTF8 > lov-index-offences.csv
# Note the use of `iconv` here as the output of awk on this input included some non-UTF8 characters
...
```

_However_ given issues encountered with `awk` (charset related, "special" chars e.g. smart quotes, HTML chars - &nbsp; etc.)
and the obscurity implicit in sequences of regex string "substitute" commands it may very well be better to handle future such processing with e.g. a Kotlin script.
